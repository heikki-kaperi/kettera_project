XAMPP mySQL database

kettera.sql

//////////////////////////////////////////////////////////

-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- Host: 127.0.0.1
-- Generation Time: Nov 10, 2025 at 07:34 PM
-- Server version: 10.4.32-MariaDB
-- PHP Version: 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `kettera`
--

-- --------------------------------------------------------

--
-- Table structure for table `administrator`
--

CREATE TABLE `administrator` (
  `Administrator_ID` int(6) UNSIGNED NOT NULL,
  `First_name` varchar(255) DEFAULT NULL,
  `Last_name` varchar(255) DEFAULT NULL,
  `Username` varchar(50) DEFAULT NULL,
  `Password` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `administrator`
--

INSERT INTO `administrator` (`Administrator_ID`, `First_name`, `Last_name`, `Username`, `Password`) VALUES
(1, 'Pekka', 'Honkanen', 'Ferrari', '12021982!Ph');

-- --------------------------------------------------------

--
-- Table structure for table `comments`
--

CREATE TABLE `comments` (
  `Comment_ID` int(10) UNSIGNED NOT NULL,
  `Contract_NR` int(10) UNSIGNED DEFAULT NULL,
  `Contract_Block_NR` int(10) UNSIGNED DEFAULT NULL,
  `User_ID` int(10) UNSIGNED DEFAULT NULL,
  `User_type` enum('internal','external') DEFAULT NULL,
  `Comment_text` text DEFAULT NULL,
  `Comment_date` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `comments`
--

INSERT INTO `comments` (`Comment_ID`, `Contract_NR`, `Contract_Block_NR`, `User_ID`, `User_type`, `Comment_text`, `Comment_date`) VALUES
(1, 1, 1, 1, 'internal', 'Please review the general terms section.', '2025-11-10 20:28:43');

-- --------------------------------------------------------

--
-- Table structure for table `contract`
--

CREATE TABLE `contract` (
  `Contract_NR` int(10) UNSIGNED NOT NULL,
  `Company_name` varchar(200) DEFAULT NULL,
  `The_Creator` int(6) UNSIGNED DEFAULT NULL,
  `Created_date` datetime DEFAULT NULL,
  `Approved` tinyint(1) DEFAULT NULL,
  `Sent_to_external` tinyint(1) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract`
--

INSERT INTO `contract` (`Contract_NR`, `Company_name`, `The_Creator`, `Created_date`, `Approved`, `Sent_to_external`) VALUES
(1, 'Northern Solutions Oy', 1, '2025-11-10 20:26:39', 0, 0);

-- --------------------------------------------------------

--
-- Table structure for table `contract_block`
--

CREATE TABLE `contract_block` (
  `Contract_Block_NR` int(10) UNSIGNED NOT NULL,
  `Org_Cont_ID` int(10) UNSIGNED DEFAULT NULL,
  `Contract_text` text DEFAULT NULL,
  `New` tinyint(1) DEFAULT NULL,
  `Modified_date` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract_block`
--

INSERT INTO `contract_block` (`Contract_Block_NR`, `Org_Cont_ID`, `Contract_text`, `New`, `Modified_date`) VALUES
(1, 1, 'This is the current contract block version of the general terms.', 1, '2025-11-10 20:26:27');

-- --------------------------------------------------------

--
-- Table structure for table `contract_blocks`
--

CREATE TABLE `contract_blocks` (
  `Contract_NR` int(10) UNSIGNED NOT NULL,
  `Contract_Block_NR` int(10) UNSIGNED NOT NULL,
  `Block_order` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract_blocks`
--

INSERT INTO `contract_blocks` (`Contract_NR`, `Contract_Block_NR`, `Block_order`) VALUES
(1, 1, 1);

-- --------------------------------------------------------

--
-- Table structure for table `contract_block_category`
--

CREATE TABLE `contract_block_category` (
  `Category_name` varchar(100) NOT NULL,
  `Description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract_block_category`
--

INSERT INTO `contract_block_category` (`Category_name`, `Description`) VALUES
('General Terms', 'Contains general terms and conditions applicable to all contracts');

-- --------------------------------------------------------

--
-- Table structure for table `contract_external_users`
--

CREATE TABLE `contract_external_users` (
  `Contract_NR` int(10) UNSIGNED NOT NULL,
  `Ext_User_ID` int(10) UNSIGNED NOT NULL,
  `Invited_date` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract_external_users`
--

INSERT INTO `contract_external_users` (`Contract_NR`, `Ext_User_ID`, `Invited_date`) VALUES
(1, 1, '2025-11-10 20:28:30');

-- --------------------------------------------------------

--
-- Table structure for table `contract_stakeholders`
--

CREATE TABLE `contract_stakeholders` (
  `Contract_NR` int(10) UNSIGNED NOT NULL,
  `Int_User_ID` int(6) UNSIGNED NOT NULL,
  `Has_approval_rights` tinyint(1) DEFAULT NULL,
  `Approved` tinyint(1) DEFAULT NULL,
  `Approved_date` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `contract_stakeholders`
--

INSERT INTO `contract_stakeholders` (`Contract_NR`, `Int_User_ID`, `Has_approval_rights`, `Approved`, `Approved_date`) VALUES
(1, 1, 1, 0, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `external_user`
--

CREATE TABLE `external_user` (
  `Ext_User_ID` int(6) UNSIGNED NOT NULL,
  `First_name` varchar(255) DEFAULT NULL,
  `Last_name` varchar(255) DEFAULT NULL,
  `Company_name` varchar(200) DEFAULT NULL,
  `Email` varchar(100) DEFAULT NULL,
  `Username` varchar(50) DEFAULT NULL,
  `Password` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `external_user`
--

INSERT INTO `external_user` (`Ext_User_ID`, `First_name`, `Last_name`, `Company_name`, `Email`, `Username`, `Password`) VALUES
(1, 'Mikko', 'Aho', 'Vuokra-apu Oy', 'mikko.aho@vuokrapu.fi', 'Vuokrapu_Mikko', '1234AhonMikke');

-- --------------------------------------------------------

--
-- Table structure for table `internal_user`
--

CREATE TABLE `internal_user` (
  `Int_User_ID` int(6) UNSIGNED NOT NULL,
  `First_name` varchar(255) DEFAULT NULL,
  `Last_name` varchar(255) DEFAULT NULL,
  `Username` varchar(50) DEFAULT NULL,
  `Password` varchar(255) DEFAULT NULL,
  `Email` varchar(100) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `internal_user`
--

INSERT INTO `internal_user` (`Int_User_ID`, `First_name`, `Last_name`, `Username`, `Password`, `Email`) VALUES
(1, 'Milla', 'Tiihonen', 'Bulldog', 'Mittens1saCat', 'milla.tiihonen@gmail.com');

-- --------------------------------------------------------

--
-- Table structure for table `original_contract_block`
--

CREATE TABLE `original_contract_block` (
  `Org_Cont_ID` int(10) UNSIGNED NOT NULL,
  `Category_name` varchar(100) DEFAULT NULL,
  `Contract_text` text DEFAULT NULL,
  `Created_by` int(6) UNSIGNED DEFAULT NULL,
  `Created_date` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `original_contract_block`
--

INSERT INTO `original_contract_block` (`Org_Cont_ID`, `Category_name`, `Contract_text`, `Created_by`, `Created_date`) VALUES
(1, 'General Terms', 'This is the original text for the general terms section.', 1, '2025-11-10 20:26:15');

--
-- Indexes for dumped tables
--

--
-- Indexes for table `administrator`
--
ALTER TABLE `administrator`
  ADD PRIMARY KEY (`Administrator_ID`),
  ADD UNIQUE KEY `Username` (`Username`);

--
-- Indexes for table `comments`
--
ALTER TABLE `comments`
  ADD PRIMARY KEY (`Comment_ID`),
  ADD KEY `Contract_NR` (`Contract_NR`),
  ADD KEY `Contract_Block_NR` (`Contract_Block_NR`);

--
-- Indexes for table `contract`
--
ALTER TABLE `contract`
  ADD PRIMARY KEY (`Contract_NR`),
  ADD KEY `The_Creator` (`The_Creator`);

--
-- Indexes for table `contract_block`
--
ALTER TABLE `contract_block`
  ADD PRIMARY KEY (`Contract_Block_NR`),
  ADD KEY `Org_Cont_ID` (`Org_Cont_ID`);

--
-- Indexes for table `contract_blocks`
--
ALTER TABLE `contract_blocks`
  ADD PRIMARY KEY (`Contract_NR`,`Contract_Block_NR`),
  ADD KEY `Contract_Block_NR` (`Contract_Block_NR`);

--
-- Indexes for table `contract_block_category`
--
ALTER TABLE `contract_block_category`
  ADD PRIMARY KEY (`Category_name`);

--
-- Indexes for table `contract_external_users`
--
ALTER TABLE `contract_external_users`
  ADD PRIMARY KEY (`Contract_NR`,`Ext_User_ID`),
  ADD KEY `Ext_User_ID` (`Ext_User_ID`);

--
-- Indexes for table `contract_stakeholders`
--
ALTER TABLE `contract_stakeholders`
  ADD PRIMARY KEY (`Contract_NR`,`Int_User_ID`),
  ADD KEY `Int_User_ID` (`Int_User_ID`);

--
-- Indexes for table `external_user`
--
ALTER TABLE `external_user`
  ADD PRIMARY KEY (`Ext_User_ID`),
  ADD UNIQUE KEY `Username` (`Username`);

--
-- Indexes for table `internal_user`
--
ALTER TABLE `internal_user`
  ADD PRIMARY KEY (`Int_User_ID`),
  ADD UNIQUE KEY `Username` (`Username`);

--
-- Indexes for table `original_contract_block`
--
ALTER TABLE `original_contract_block`
  ADD PRIMARY KEY (`Org_Cont_ID`),
  ADD KEY `Category_name` (`Category_name`),
  ADD KEY `Created_by` (`Created_by`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `administrator`
--
ALTER TABLE `administrator`
  MODIFY `Administrator_ID` int(6) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `comments`
--
ALTER TABLE `comments`
  MODIFY `Comment_ID` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `contract`
--
ALTER TABLE `contract`
  MODIFY `Contract_NR` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `contract_block`
--
ALTER TABLE `contract_block`
  MODIFY `Contract_Block_NR` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `external_user`
--
ALTER TABLE `external_user`
  MODIFY `Ext_User_ID` int(6) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `internal_user`
--
ALTER TABLE `internal_user`
  MODIFY `Int_User_ID` int(6) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `original_contract_block`
--
ALTER TABLE `original_contract_block`
  MODIFY `Org_Cont_ID` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- Constraints for dumped tables
--

--
-- Constraints for table `comments`
--
ALTER TABLE `comments`
  ADD CONSTRAINT `comments_ibfk_1` FOREIGN KEY (`Contract_NR`) REFERENCES `contract` (`Contract_NR`),
  ADD CONSTRAINT `comments_ibfk_2` FOREIGN KEY (`Contract_Block_NR`) REFERENCES `contract_block` (`Contract_Block_NR`);

--
-- Constraints for table `contract`
--
ALTER TABLE `contract`
  ADD CONSTRAINT `contract_ibfk_1` FOREIGN KEY (`The_Creator`) REFERENCES `internal_user` (`Int_User_ID`);

--
-- Constraints for table `contract_block`
--
ALTER TABLE `contract_block`
  ADD CONSTRAINT `contract_block_ibfk_1` FOREIGN KEY (`Org_Cont_ID`) REFERENCES `original_contract_block` (`Org_Cont_ID`);

--
-- Constraints for table `contract_blocks`
--
ALTER TABLE `contract_blocks`
  ADD CONSTRAINT `contract_blocks_ibfk_1` FOREIGN KEY (`Contract_NR`) REFERENCES `contract` (`Contract_NR`),
  ADD CONSTRAINT `contract_blocks_ibfk_2` FOREIGN KEY (`Contract_Block_NR`) REFERENCES `contract_block` (`Contract_Block_NR`);

--
-- Constraints for table `contract_external_users`
--
ALTER TABLE `contract_external_users`
  ADD CONSTRAINT `contract_external_users_ibfk_1` FOREIGN KEY (`Contract_NR`) REFERENCES `contract` (`Contract_NR`),
  ADD CONSTRAINT `contract_external_users_ibfk_2` FOREIGN KEY (`Ext_User_ID`) REFERENCES `external_user` (`Ext_User_ID`);

--
-- Constraints for table `contract_stakeholders`
--
ALTER TABLE `contract_stakeholders`
  ADD CONSTRAINT `contract_stakeholders_ibfk_1` FOREIGN KEY (`Contract_NR`) REFERENCES `contract` (`Contract_NR`),
  ADD CONSTRAINT `contract_stakeholders_ibfk_2` FOREIGN KEY (`Int_User_ID`) REFERENCES `internal_user` (`Int_User_ID`);

--
-- Constraints for table `original_contract_block`
--
ALTER TABLE `original_contract_block`
  ADD CONSTRAINT `original_contract_block_ibfk_1` FOREIGN KEY (`Category_name`) REFERENCES `contract_block_category` (`Category_name`),
  ADD CONSTRAINT `original_contract_block_ibfk_2` FOREIGN KEY (`Created_by`) REFERENCES `internal_user` (`Int_User_ID`);
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;



//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

All text below is Visual Studio 2022 "Console App (.NET Framework)" .cs files. Project name "ContractManagement.Model.Entities"

DbHelper.cs

//////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;
using System.Reflection;

namespace ContractManagement.Model.DAL
{
    public static class DbHelper
    {
        public static string ConnectionString = "server=127.0.0.1;user=root;database=kettera;password=";

        public static MySqlConnection GetConnection()
        {
            return new MySqlConnection(ConnectionString);
        }

        // Dynamically adds parameters from an anonymous object or dictionary
        public static void AddParams(this MySqlCommand cmd, object paramObj)
        {
            if (paramObj == null) return;

            foreach (PropertyInfo prop in paramObj.GetType().GetProperties())
            {
                var name = "@" + prop.Name;
                var value = prop.GetValue(paramObj) ?? DBNull.Value;
                cmd.Parameters.AddWithValue(name, value);
            }
        }

        // Simplified ExecuteNonQuery
        public static bool ExecuteNonQuery(string sql, object param = null)
        {
            using (var conn = GetConnection())
            {
                conn.Open();
                using (var cmd = new MySqlCommand(sql, conn))
                {
                    cmd.AddParams(param);
                    return cmd.ExecuteNonQuery() > 0;
                }
            }
        }

        // Simplified ExecuteScalar
        public static object ExecuteScalar(string sql, object param = null)
        {
            using (var conn = GetConnection())
            {
                conn.Open();
                using (var cmd = new MySqlCommand(sql, conn))
                {
                    cmd.AddParams(param);
                    return cmd.ExecuteScalar();
                }
            }
        }
    }
}

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

SqlBuilder.cs

//////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ContractManagement.Model.DAL
{
    public static class SqlBuilder
    {
        // Build a standard INSERT query
        public static string Insert(string table, params string[] columns)
        {
            string columnList = string.Join(", ", columns);
            string paramList = string.Join(", ", columns.Select(c => "@" + c));
            return $"INSERT INTO {table} ({columnList}) VALUES ({paramList});";
        }

        // Build an UPDATE query with WHERE clause key(s)
        public static string Update(string table, string keyColumn, params string[] columns)
        {
            string setClause = string.Join(", ", columns.Select(c => $"{c}=@{c}"));
            return $"UPDATE {table} SET {setClause} WHERE {keyColumn}=@{keyColumn};";
        }

        // Build an INSERT that returns the last inserted ID (for auto-increment keys)
        public static string InsertWithId(string table, params string[] columns)
        {
            return Insert(table, columns) + " SELECT LAST_INSERT_ID();";
        }
    }
}

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

ModelLayer.cs

//////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;

// ==================== ENTITY CLASSES ====================

namespace ContractManagement.Model.Entities
{
    public class Administrator
    {
        public int Administrator_ID { get; set; }
        public string First_name { get; set; }
        public string Last_name { get; set; }
        public string Username { get; set; }
        public string Password { get; set; }
    }

    public class InternalUser
    {
        public int Int_User_ID { get; set; }
        public string First_name { get; set; }
        public string Last_name { get; set; }
        public string Username { get; set; }
        public string Password { get; set; }
        public string Email { get; set; }
    }

    public class ExternalUser
    {
        public int Ext_User_ID { get; set; }
        public string First_name { get; set; }
        public string Last_name { get; set; }
        public string Company_name { get; set; }
        public string Email { get; set; }
        public string Username { get; set; }
        public string Password { get; set; }
    }

    public class ContractBlockCategory
    {
        public string Category_name { get; set; }
        public string Description { get; set; }
    }

    public class OriginalContractBlock
    {
        public int Org_Cont_ID { get; set; }
        public string Category_name { get; set; }
        public string Contract_text { get; set; }
        public int Created_by { get; set; }
        public DateTime Created_date { get; set; }
    }

    public class ContractBlock
    {
        public int Contract_Block_NR { get; set; }
        public int Org_Cont_ID { get; set; }
        public string Contract_text { get; set; }
        public bool New { get; set; }
        public DateTime Modified_date { get; set; }
    }

    public class Contract
    {
        public int Contract_NR { get; set; }
        public string Company_name { get; set; }
        public int The_Creator { get; set; }
        public DateTime Created_date { get; set; }
        public bool Approved { get; set; }
        public bool Sent_to_external { get; set; }
    }

    public class ContractStakeholder
    {
        public int Contract_NR { get; set; }
        public int Int_User_ID { get; set; }
        public bool Has_approval_rights { get; set; }
        public bool Approved { get; set; }
        public DateTime? Approved_date { get; set; }
    }

    public class ContractExternalUser
    {
        public int Contract_NR { get; set; }
        public int Ext_User_ID { get; set; }
        public DateTime Invited_date { get; set; }
    }

    public class Comment
    {
        public int Comment_ID { get; set; }
        public int Contract_NR { get; set; }
        public int? Contract_Block_NR { get; set; }
        public int User_ID { get; set; }
        public string User_type { get; set; } // 'internal' or 'external'
        public string Comment_text { get; set; }
        public DateTime Comment_date { get; set; }
    }
}

// ==================== DATABASE ACCESS CLASSES ====================

namespace ContractManagement.Model.DAL
{
    using System.Data.SqlClient;
    using ContractManagement.Model.Entities;

    public class DatabaseConnection
    {
        private string connectionString = "server=127.0.0.1;user=root;database=kettera;password=";

        public MySqlConnection GetConnection()
        {
            return new MySqlConnection(connectionString);
        }
    }

    // ==================== ADMINISTRATOR DAL ====================
    public class AdministratorDAL
    {
        private DatabaseConnection dbConn = new DatabaseConnection();

        public Administrator GetAdministratorByUsername(string username)
        {
            Administrator admin = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM administrator WHERE Username = @username";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@username", username);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        admin = new Administrator
                        {
                            Administrator_ID = reader.GetInt32("Administrator_ID"),
                            First_name = reader.GetString("First_name"),
                            Last_name = reader.GetString("Last_name"),
                            Username = reader.GetString("Username"),
                            Password = reader.GetString("Password")
                        };
                    }
                }
            }
            return admin;
        }

        public bool CreateAdministrator(Administrator admin) =>
            DbHelper.ExecuteNonQuery(
            SqlBuilder.Insert("administator", "First_name", "Last_name", "Username", "Password", "Email"),
            admin
         );

    }

    // ==================== INTERNAL USER DAL ====================
    public class InternalUserDAL
    {

        private InternalUser MapReaderToInternalUser(MySqlDataReader reader)
        {
            return new InternalUser
            {
                Int_User_ID = reader.GetInt32("Int_User_ID"),
                First_name = reader.GetString("First_name"),
                Last_name = reader.GetString("Last_name"),
                Username = reader.GetString("Username"),
                Password = reader.GetString("Password"),
                Email = reader.GetString("Email")
            };
        }

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<InternalUser> GetAllInternalUsers()
        {
            List<InternalUser> users = new List<InternalUser>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM internal_user";
                MySqlCommand cmd = new MySqlCommand(query, conn);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        users.Add(MapReaderToInternalUser(reader));
                    }
                }
            }
            return users;
        }

        public InternalUser GetInternalUserById(int userId)
        {
            InternalUser user = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM internal_user WHERE Int_User_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", userId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        user = MapReaderToInternalUser(reader);
                    }
                }
            }
            return user;
        }

        public InternalUser GetInternalUserByUsername(string username)
        {
            InternalUser user = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM internal_user WHERE Username = @username";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@username", username);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        user = MapReaderToInternalUser(reader);
                    }
                }
            }
            return user;
        }

        public bool CreateInternalUser(InternalUser user) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Insert("internal_user", "First_name", "Last_name", "Username", "Password", "Email"),
                user
            );

        public bool UpdateInternalUser(InternalUser user) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("internal_user", "Int_User_ID", "First_name", "Last_name", "Username", "Password", "Email"),
                user
            );

        public bool DeleteInternalUser(int userId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM internal_user WHERE Int_User_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", userId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== EXTERNAL USER DAL ====================
    public class ExternalUserDAL
    {

        private ExternalUser MapReaderToExternalUser(MySqlDataReader reader)
        {
            return new ExternalUser
            {
                Ext_User_ID = reader.GetInt32("Ext_User_ID"),
                First_name = reader.GetString("First_name"),
                Last_name = reader.GetString("Last_name"),
                Username = reader.GetString("Username"),
                Password = reader.GetString("Password"),
                Email = reader.GetString("Email"),
                Company_name = reader.GetString("Company_name")
            };
        }

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<ExternalUser> GetAllExternalUsers()
        {
            List<ExternalUser> users = new List<ExternalUser>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM external_user";
                MySqlCommand cmd = new MySqlCommand(query, conn);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        users.Add(MapReaderToExternalUser(reader));
                    }
                }
            }
            return users;
        }

        public ExternalUser GetExternalUserById(int userId)
        {
            ExternalUser user = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM external_user WHERE Ext_User_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", userId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        user = MapReaderToExternalUser(reader);
                    }
                }
            }
            return user;
        }

        public ExternalUser GetExternalUserByUsername(string username)
        {
            ExternalUser user = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM external_user WHERE Username = @username";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@username", username);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        user = MapReaderToExternalUser(reader);
                    }
                }
            }
            return user;
        }

        public bool CreateExternalUser(ExternalUser user) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Insert("external_user", "First_name", "Last_name", "Company_name", "Email", "Username", "Password"),
                user
            );

        public bool UpdateExternalUser(ExternalUser user) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("external_user", "Int_User_ID", "First_name", "Last_name", "Company_name", "Email", "Username", "Password"),
                 user
            );

        public bool DeleteExternalUser(int userId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM external_user WHERE Ext_User_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", userId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== CATEGORY DAL ====================
    public class CategoryDAL
    {

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<ContractBlockCategory> GetAllCategories()
        {
            List<ContractBlockCategory> categories = new List<ContractBlockCategory>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract_block_category";
                MySqlCommand cmd = new MySqlCommand(query, conn);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        categories.Add(new ContractBlockCategory
                        {
                            Category_name = reader.GetString("Category_name"),
                            Description = reader.GetString("Description")
                        });
                    }
                }
            }
            return categories;
        }

        public ContractBlockCategory GetCategoryByName(string categoryName)
        {
            ContractBlockCategory category = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract_block_category WHERE Category_name = @name";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@name", categoryName);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        category = new ContractBlockCategory
                        {
                            Category_name = reader.GetString("Category_name"),
                            Description = reader.GetString("Description")
                        };
                    }
                }
            }
            return category;
        }

        public bool CreateCategory(ContractBlockCategory category)=>
        DbHelper.ExecuteNonQuery(
            SqlBuilder.Insert("contract_block_category", "Category_name", "Description"),
            category
        );

        public bool UpdateCategory(ContractBlockCategory category) =>
        DbHelper.ExecuteNonQuery(
            SqlBuilder.Update("contract_block_category", "Category_name", "Description"),
            category
    );

        public bool DeleteCategory(string categoryName)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract_block_category WHERE Category_name = @name";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@name", categoryName);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== ORIGINAL CONTRACT BLOCK DAL ====================
    public class OriginalContractBlockDAL
    {

        private OriginalContractBlock MapReaderToOriginalContractBlock(MySqlDataReader reader)
        {
            return new OriginalContractBlock
            {
                Org_Cont_ID = reader.GetInt32("Org_Cont_ID"),
                Category_name = reader.GetString("Category_name"),
                Contract_text = reader.GetString("Contract_text"),
                Created_by = reader.GetInt32("Created_by"),
                Created_date = reader.GetDateTime("Created_date")
            };
        }

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<OriginalContractBlock> GetAllOriginalBlocks()
        {
            List<OriginalContractBlock> blocks = new List<OriginalContractBlock>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM original_contract_block";
                MySqlCommand cmd = new MySqlCommand(query, conn);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        blocks.Add(MapReaderToOriginalContractBlock(reader));
                    }
                }
            }
            return blocks;
        }

        public List<OriginalContractBlock> GetOriginalBlocksByCategory(string categoryName)
        {
            List<OriginalContractBlock> blocks = new List<OriginalContractBlock>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM original_contract_block WHERE Category_name = @category";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@category", categoryName);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        blocks.Add(MapReaderToOriginalContractBlock(reader));
                    }
                }
            }
            return blocks;
        }

        public OriginalContractBlock GetOriginalBlockById(int blockId)
        {
            OriginalContractBlock block = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM original_contract_block WHERE Org_Cont_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", blockId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        block = MapReaderToOriginalContractBlock(reader);
                    }
                }
            }
            return block;
        }

        public int CreateOriginalBlock(OriginalContractBlock block)
        {
            object result = DbHelper.ExecuteScalar(
                SqlBuilder.InsertWithId("original_contract_block", "Category_name", "Contract_text", "Created_by", "Created_date"),
                block
            );
            return Convert.ToInt32(result);
        }

        public bool UpdateOriginalBlock(OriginalContractBlock block) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("original_contract_block", "Category_name", "Contract_text", "Org_Cont_ID"),
                block
            );

        public bool DeleteOriginalBlock(int blockId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM original_contract_block WHERE Org_Cont_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", blockId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== CONTRACT BLOCK DAL ====================
    public class ContractBlockDAL
    {
        private DatabaseConnection dbConn = new DatabaseConnection();

        public ContractBlock GetContractBlockById(int blockId)
        {
            ContractBlock block = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract_block WHERE Contract_Block_NR = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", blockId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        block = new ContractBlock
                        {
                            Contract_Block_NR = reader.GetInt32("Contract_Block_NR"),
                            Org_Cont_ID = reader.GetInt32("Org_Cont_ID"),
                            Contract_text = reader.GetString("Contract_text"),
                            New = reader.GetBoolean("New"),
                            Modified_date = reader.GetDateTime("Modified_date")
                        };
                    }
                }
            }
            return block;
        }

        public List<ContractBlock> GetBlocksByContract(int contractNr)
        {
            List<ContractBlock> blocks = new List<ContractBlock>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = @"SELECT cb.* FROM contract_block cb
                                INNER JOIN contract_blocks cbs ON cb.Contract_Block_NR = cbs.Contract_Block_NR
                                WHERE cbs.Contract_NR = @contractNr
                                ORDER BY cbs.Block_order";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        blocks.Add(new ContractBlock
                        {
                            Contract_Block_NR = reader.GetInt32("Contract_Block_NR"),
                            Org_Cont_ID = reader.GetInt32("Org_Cont_ID"),
                            Contract_text = reader.GetString("Contract_text"),
                            New = reader.GetBoolean("New"),
                            Modified_date = reader.GetDateTime("Modified_date")
                        });
                    }
                }
            }
            return blocks;
        }

        public int CreateContractBlock(ContractBlock block)
        {
            object result = DbHelper.ExecuteScalar(
                SqlBuilder.InsertWithId("contract_block", "Org_Cont_ID", "Contract_text", "New", "Modified_date"),
                block
            );
            return Convert.ToInt32(result);
        }

        public bool UpdateContractBlock(ContractBlock block) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("contract_block", "Org_Cont_ID", "Contract_text", "New", "Modified_date"),
                block
            );

        public bool DeleteContractBlock(int blockId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract_block WHERE Contract_Block_NR = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", blockId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

        public bool AddBlockToContract(int contractNr, int blockNr, int blockOrder)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "INSERT INTO contract_blocks (Contract_NR, Contract_Block_NR, Block_order) VALUES (@contractNr, @blockNr, @order)";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@blockNr", blockNr);
                cmd.Parameters.AddWithValue("@order", blockOrder);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

        public bool RemoveBlockFromContract(int contractNr, int blockNr)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract_blocks WHERE Contract_NR = @contractNr AND Contract_Block_NR = @blockNr";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@blockNr", blockNr);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== CONTRACT DAL ====================
    public class ContractDAL
    {
        private Contract MapReaderToContract(MySqlDataReader reader)
        {
            return new Contract
            {
                Contract_NR = reader.GetInt32("Contract_NR"),
                Company_name = reader.GetString("Company_name"),
                The_Creator = reader.GetInt32("The_Creator"),
                Created_date = reader.GetDateTime("Created_date"),
                Approved = reader.GetBoolean("Approved"),
                Sent_to_external = reader.GetBoolean("Sent_to_external")
            };
        }

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<Contract> GetAllContracts()
        {
            List<Contract> contracts = new List<Contract>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract";
                MySqlCommand cmd = new MySqlCommand(query, conn);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        contracts.Add(MapReaderToContract(reader));
                    }
                }
            }
            return contracts;
        }

        public Contract GetContractById(int contractId)
        {
            Contract contract = null;
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract WHERE Contract_NR = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", contractId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        contract = MapReaderToContract(reader);
                    }
                }
            }
            return contract;
        }

        public List<Contract> GetContractsByCreator(int creatorId)
        {
            List<Contract> contracts = new List<Contract>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract WHERE The_Creator = @creator";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@creator", creatorId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        contracts.Add(MapReaderToContract(reader));
                    }
                }
            }
            return contracts;
        }

        public int CreateContract(Contract contract)
        {
            object result = DbHelper.ExecuteScalar(
                SqlBuilder.InsertWithId("contract", "Company_name", "The_Creator", "Created_date", "Approved", "Sent_to_external"),
                contract
            );
            return Convert.ToInt32(result);
        }

        public bool UpdateContract(Contract contract) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("contract", "Contract_NR", "Company_name", "Approved", "Sent_to_external"),
                contract
            );

        public bool DeleteContract(int contractId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract WHERE Contract_NR = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", contractId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== CONTRACT STAKEHOLDER DAL ====================
    public class ContractStakeholderDAL
    {
        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<ContractStakeholder> GetStakeholdersByContract(int contractNr)
        {
            List<ContractStakeholder> stakeholders = new List<ContractStakeholder>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM contract_stakeholders WHERE Contract_NR = @contractNr";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        stakeholders.Add(new ContractStakeholder
                        {
                            Contract_NR = reader.GetInt32("Contract_NR"),
                            Int_User_ID = reader.GetInt32("Int_User_ID"),
                            Has_approval_rights = reader.GetBoolean("Has_approval_rights"),
                            Approved = reader.GetBoolean("Approved"),
                            Approved_date = reader.IsDBNull(reader.GetOrdinal("Approved_date")) ? null : (DateTime?)reader.GetDateTime("Approved_date")
                        });
                    }
                }
            }
            return stakeholders;
        }

        public List<Contract> GetContractsByStakeholder(int userId)
        {
            List<Contract> contracts = new List<Contract>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = @"SELECT c.* FROM contract c
                                INNER JOIN contract_stakeholders cs ON c.Contract_NR = cs.Contract_NR
                                WHERE cs.Int_User_ID = @userId";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@userId", userId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        contracts.Add(new Contract
                        {
                            Contract_NR = reader.GetInt32("Contract_NR"),
                            Company_name = reader.GetString("Company_name"),
                            The_Creator = reader.GetInt32("The_Creator"),
                            Created_date = reader.GetDateTime("Created_date"),
                            Approved = reader.GetBoolean("Approved"),
                            Sent_to_external = reader.GetBoolean("Sent_to_external")
                        });
                    }
                }
            }
            return contracts;
        }

        public bool AddStakeholder(ContractStakeholder stakeholder) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Insert("contract_stakeholders", "Contract_NR", "Int_User_ID", "Has_approval_rights", "Approved", "Approved_date"),
                stakeholder
            );

        public bool UpdateStakeholder(ContractStakeholder stakeholder) =>
            DbHelper.ExecuteNonQuery(
                SqlBuilder.Update("contract_stakeholders", "Contract_NR", "Int_User_ID", "Has_approval_rights", "Approved", "Approved_date"),
            stakeholder
            );

        public bool RemoveStakeholder(int contractNr, int userId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract_stakeholders WHERE Contract_NR = @contractNr AND Int_User_ID = @userId";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@userId", userId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

        public bool IsContractFullyApproved(int contractNr)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT COUNT(*) FROM contract_stakeholders WHERE Contract_NR = @contractNr AND Has_approval_rights = 1 AND Approved = 0";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                int unapprovedCount = Convert.ToInt32(cmd.ExecuteScalar());
                return unapprovedCount == 0;
            }
        }
    }

    // ==================== CONTRACT EXTERNAL USERS DAL ====================
    public class ContractExternalUserDAL
    {
        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<ExternalUser> GetExternalUsersByContract(int contractNr)
        {
            List<ExternalUser> users = new List<ExternalUser>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = @"SELECT eu.* FROM external_user eu
                                INNER JOIN contract_external_users ceu ON eu.Ext_User_ID = ceu.Ext_User_ID
                                WHERE ceu.Contract_NR = @contractNr";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        users.Add(new ExternalUser
                        {
                            Ext_User_ID = reader.GetInt32("Ext_User_ID"),
                            First_name = reader.GetString("First_name"),
                            Last_name = reader.GetString("Last_name"),
                            Company_name = reader.GetString("Company_name"),
                            Email = reader.GetString("Email"),
                            Username = reader.GetString("Username"),
                            Password = reader.GetString("Password")
                        });
                    }
                }
            }
            return users;
        }

        public List<Contract> GetContractsByExternalUser(int extUserId)
        {
            List<Contract> contracts = new List<Contract>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = @"SELECT c.* FROM contract c
                                INNER JOIN contract_external_users ceu ON c.Contract_NR = ceu.Contract_NR
                                WHERE ceu.Ext_User_ID = @userId";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@userId", extUserId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        contracts.Add(new Contract
                        {
                            Contract_NR = reader.GetInt32("Contract_NR"),
                            Company_name = reader.GetString("Company_name"),
                            The_Creator = reader.GetInt32("The_Creator"),
                            Created_date = reader.GetDateTime("Created_date"),
                            Approved = reader.GetBoolean("Approved"),
                            Sent_to_external = reader.GetBoolean("Sent_to_external")
                        });
                    }
                }
            }
            return contracts;
        }

        public bool InviteExternalUser(int contractNr, int extUserId, DateTime invitedDate)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "INSERT INTO contract_external_users (Contract_NR, Ext_User_ID, Invited_date) VALUES (@contractNr, @userId, @date)";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@userId", extUserId);
                cmd.Parameters.AddWithValue("@date", invitedDate);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

        public bool RemoveExternalUser(int contractNr, int extUserId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM contract_external_users WHERE Contract_NR = @contractNr AND Ext_User_ID = @userId";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@userId", extUserId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }

    // ==================== COMMENT DAL ====================
    public class CommentDAL
    {

        private Comment MapReaderToComment(MySqlDataReader reader)
        {
            return new Comment
            {
                Comment_ID = reader.GetInt32("Comment_ID"),
                Contract_NR = reader.GetInt32("Contract_NR"),
                Contract_Block_NR = reader.IsDBNull(reader.GetOrdinal("Contract_Block_NR")) ? null : (int?)reader.GetInt32("Contract_Block_NR"),
                User_ID = reader.GetInt32("User_ID"),
                User_type = reader.GetString("User_type"),
                Comment_text = reader.GetString("Comment_text"),
                Comment_date = reader.GetDateTime("Comment_date")
            }; 
        }

        private DatabaseConnection dbConn = new DatabaseConnection();

        public List<Comment> GetCommentsByContract(int contractNr)
        {
            List<Comment> comments = new List<Comment>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM comments WHERE Contract_NR = @contractNr ORDER BY Comment_date";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        comments.Add(MapReaderToComment(reader));
                    }
                }
            }
            return comments;
        }

        public List<Comment> GetCommentsByBlock(int contractNr, int blockNr)
        {
            List<Comment> comments = new List<Comment>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM comments WHERE Contract_NR = @contractNr AND Contract_Block_NR = @blockNr ORDER BY Comment_date";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@blockNr", blockNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        comments.Add(MapReaderToComment(reader));
                    }
                }
            }
            return comments;
        }

        public List<Comment> GetInternalComments(int contractNr)
        {
            List<Comment> comments = new List<Comment>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM comments WHERE Contract_NR = @contractNr AND User_type = 'internal' ORDER BY Comment_date";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        comments.Add(MapReaderToComment(reader));
                    }
                }
            }
            return comments;
        }

        public List<Comment> GetExternalCommentsByUser(int contractNr, int extUserId)
        {
            List<Comment> comments = new List<Comment>();
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "SELECT * FROM comments WHERE Contract_NR = @contractNr AND User_type = 'external' AND User_ID = @userId ORDER BY Comment_date";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", contractNr);
                cmd.Parameters.AddWithValue("@userId", extUserId);

                using (MySqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        comments.Add(MapReaderToComment(reader));
                    }
                }
            }
            return comments;
        }

        public int CreateComment(Comment comment)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "INSERT INTO comments (Contract_NR, Contract_Block_NR, User_ID, User_type, Comment_text, Comment_date) VALUES (@contractNr, @blockNr, @userId, @userType, @text, @date); SELECT LAST_INSERT_ID();";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@contractNr", comment.Contract_NR);
                cmd.Parameters.AddWithValue("@blockNr", comment.Contract_Block_NR.HasValue ? (object)comment.Contract_Block_NR.Value : DBNull.Value);
                cmd.Parameters.AddWithValue("@userId", comment.User_ID);
                cmd.Parameters.AddWithValue("@userType", comment.User_type);
                cmd.Parameters.AddWithValue("@text", comment.Comment_text);
                cmd.Parameters.AddWithValue("@date", comment.Comment_date);

                return Convert.ToInt32(cmd.ExecuteScalar());
            }
        }

        public bool DeleteComment(int commentId)
        {
            using (MySqlConnection conn = dbConn.GetConnection())
            {
                conn.Open();
                string query = "DELETE FROM comments WHERE Comment_ID = @id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", commentId);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

    }

}

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

Controllers.cs

//////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using ContractManagement.Model.Entities;
using ContractManagement.Model.DAL;

namespace ContractManagement.Controller
{
    // ==================== USER CONTROLLER ====================
    public class UserController
    {
        private AdministratorDAL adminDAL = new AdministratorDAL();
        private InternalUserDAL internalUserDAL = new InternalUserDAL();
        private ExternalUserDAL externalUserDAL = new ExternalUserDAL();

        // Login methods
        public Administrator LoginAdministrator(string username, string password)
        {
            Administrator admin = adminDAL.GetAdministratorByUsername(username);
            if (admin != null && admin.Password == password)
                return admin;
            return null;
        }

        public InternalUser LoginInternalUser(string username, string password)
        {
            InternalUser user = internalUserDAL.GetInternalUserByUsername(username);
            if (user != null && user.Password == password)
                return user;
            return null;
        }

        public ExternalUser LoginExternalUser(string username, string password)
        {
            ExternalUser user = externalUserDAL.GetExternalUserByUsername(username);
            if (user != null && user.Password == password)
                return user;
            return null;
        }

        // Internal users
        public List<InternalUser> GetAllInternalUsers() => internalUserDAL.GetAllInternalUsers();

        public bool CreateInternalUser(string fname, string lname, string email, string username, string password)
        {
            InternalUser user = new InternalUser
            {
                First_name = fname,
                Last_name = lname,
                Email = email,
                Username = username,
                Password = password
            };
            return internalUserDAL.CreateInternalUser(user);
        }

        public bool UpdateInternalUser(InternalUser user) => internalUserDAL.UpdateInternalUser(user);
        public bool DeleteInternalUser(int userId) => internalUserDAL.DeleteInternalUser(userId);
        public InternalUser GetInternalUserByUsername(string username) => internalUserDAL.GetInternalUserByUsername(username);

        // External users
        public List<ExternalUser> GetAllExternalUsers() => externalUserDAL.GetAllExternalUsers();

        public bool CreateExternalUser(string fname, string lname, string company, string email, string username, string password)
        {
            ExternalUser user = new ExternalUser
            {
                First_name = fname,
                Last_name = lname,
                Company_name = company,
                Email = email,
                Username = username,
                Password = password
            };
            return externalUserDAL.CreateExternalUser(user);
        }

        public bool UpdateExternalUser(ExternalUser user) => externalUserDAL.UpdateExternalUser(user);
        public bool DeleteExternalUser(int userId) => externalUserDAL.DeleteExternalUser(userId);
        public ExternalUser GetExternalUserByUsername(string username) => externalUserDAL.GetExternalUserByUsername(username);
    }

    // ==================== BLOCK CONTROLLER ====================
    public class BlockController
    {
        private CategoryDAL categoryDAL = new CategoryDAL();
        private OriginalContractBlockDAL originalDAL = new OriginalContractBlockDAL();
        private ContractBlockDAL blockDAL = new ContractBlockDAL();

        // Categories
        public List<ContractBlockCategory> GetAllCategories() => categoryDAL.GetAllCategories();

        public bool CreateCategory(string name, string description)
        {
            return categoryDAL.CreateCategory(new ContractBlockCategory
            {
                Category_name = name,
                Description = description
            });
        }

        // Original blocks
        public List<OriginalContractBlock> GetAllOriginalBlocks() => originalDAL.GetAllOriginalBlocks();

        public List<OriginalContractBlock> GetOriginalBlocksByCategory(string category)
            => originalDAL.GetOriginalBlocksByCategory(category);

        public bool CreateOriginalBlock(string category, string text, int createdBy)
        {
            OriginalContractBlock block = new OriginalContractBlock
            {
                Category_name = category,
                Contract_text = text,
                Created_by = createdBy,
                Created_date = DateTime.Now
            };
            return originalDAL.CreateOriginalBlock(block) > 0;
        }

        public bool CopyOriginalBlock(int originalBlockId, int createdBy)
        {
            OriginalContractBlock original = originalDAL.GetOriginalBlockById(originalBlockId);
            if (original == null) return false;

            OriginalContractBlock copy = new OriginalContractBlock
            {
                Category_name = original.Category_name,
                Contract_text = original.Contract_text + " (Copy)",
                Created_by = createdBy,
                Created_date = DateTime.Now
            };
            return originalDAL.CreateOriginalBlock(copy) > 0;
        }

        // Contract blocks
        public int CreateContractBlock(int orgId, string text, bool isNew)
        {
            ContractBlock block = new ContractBlock
            {
                Org_Cont_ID = orgId,
                Contract_text = text,
                New = isNew,
                Modified_date = DateTime.Now
            };
            return blockDAL.CreateContractBlock(block);
        }

        public bool UpdateContractBlock(int blockId, string newText)
        {
            ContractBlock block = blockDAL.GetContractBlockById(blockId);
            if (block == null) return false;

            block.Contract_text = newText;
            block.Modified_date = DateTime.Now;
            return blockDAL.UpdateContractBlock(block);
        }
    }

    // ==================== CONTRACT CONTROLLER ====================
    public class ContractController
    {
        private ContractDAL contractDAL = new ContractDAL();
        private ContractBlockDAL blockDAL = new ContractBlockDAL();
        private OriginalContractBlockDAL originalDAL = new OriginalContractBlockDAL();
        private ContractStakeholderDAL stakeholderDAL = new ContractStakeholderDAL();
        private ContractExternalUserDAL externalDAL = new ContractExternalUserDAL();

        public int CreateContract(string companyName, int creatorId)
        {
            Contract contract = new Contract
            {
                Company_name = companyName,
                The_Creator = creatorId,
                Created_date = DateTime.Now,
                Approved = false,
                Sent_to_external = false
            };
            return contractDAL.CreateContract(contract);
        }

        public Contract GetContractById(int contractId) => contractDAL.GetContractById(contractId);

        public List<Contract> GetAllContracts() => contractDAL.GetAllContracts();

        public List<Contract> GetContractsByCreator(int creatorId) => contractDAL.GetContractsByCreator(creatorId);

        public List<Contract> GetContractsByInternalUser(int userId)
        {
            return GetContractsByCreator(userId);
        }

        public List<Contract> GetContractsByStakeholder(int userId) => stakeholderDAL.GetContractsByStakeholder(userId);

        public List<Contract> GetContractsToReviewByInternalUser(int userId)
        { 
            return GetContractsByStakeholder(userId);
        }

        public List<Contract> GetContractsByExternalUser(int extUserId) => externalDAL.GetContractsByExternalUser(extUserId);

        public bool DeleteContract(int contractNr) => contractDAL.DeleteContract(contractNr);

        // Block management in contract
        public List<ContractBlock> GetContractBlocks(int contractNr) => blockDAL.GetBlocksByContract(contractNr);

        public List<ContractBlock> GetBlocksByContract(int contractId)
        {
            return GetContractBlocks(contractId);
        }

        public bool AddBlockToContract(int contractNr, int originalBlockId)
        {
            // Get original block
            OriginalContractBlock original = originalDAL.GetOriginalBlockById(originalBlockId);
            if (original == null) return false;

            // Create contract block from original
            ContractBlock contractBlock = new ContractBlock
            {
                Org_Cont_ID = originalBlockId,
                Contract_text = original.Contract_text,
                New = true,
                Modified_date = DateTime.Now
            };

            int newBlockId = blockDAL.CreateContractBlock(contractBlock);
            if (newBlockId == 0) return false;

            // Get current max order
            var existingBlocks = blockDAL.GetBlocksByContract(contractNr);
            int maxOrder = existingBlocks.Count > 0 ? existingBlocks.Count : 0;

            // Add to contract
            return blockDAL.AddBlockToContract(contractNr, newBlockId, maxOrder + 1);
        }

        public bool RemoveBlockFromContract(int contractNr, int blockId)
            => blockDAL.RemoveBlockFromContract(contractNr, blockId);

        public bool EditBlockInContract(int blockId, string newText)
        {
            ContractBlock block = blockDAL.GetContractBlockById(blockId);
            if (block == null) return false;

            block.Contract_text = newText;
            block.Modified_date = DateTime.Now;
            return blockDAL.UpdateContractBlock(block);
        }

        public bool EditBlockInContract(int contractId, int blockId, string newText)
        {
            return EditBlockInContract(blockId, newText);
        }

        // Stakeholder management
        public bool InviteInternalReviewer(int contractNr, int userId, bool hasApprovalRights)
        {
            ContractStakeholder stakeholder = new ContractStakeholder
            {
                Contract_NR = contractNr,
                Int_User_ID = userId,
                Has_approval_rights = hasApprovalRights,
                Approved = false,
                Approved_date = null
            };
            return stakeholderDAL.AddStakeholder(stakeholder);
        }

        public bool InviteExternalUser(int contractNr, int extUserId)
        {
            bool success = externalDAL.InviteExternalUser(contractNr, extUserId, DateTime.Now);
            if (success)
            {
                // Mark contract as sent to external
                Contract contract = contractDAL.GetContractById(contractNr);
                contract.Sent_to_external = true;
                contractDAL.UpdateContract(contract);
            }
            return success;
        }
    }

    // ==================== COMMENT CONTROLLER ====================
    public class CommentController
    {
        private CommentDAL commentDAL = new CommentDAL();

        public bool AddComment(int contractNr, int? blockNr, int userId, string userType, string text)
        {
            Comment comment = new Comment
            {
                Contract_NR = contractNr,
                Contract_Block_NR = blockNr,
                User_ID = userId,
                User_type = userType,
                Comment_text = text,
                Comment_date = DateTime.Now
            };
            return commentDAL.CreateComment(comment) > 0;
        }

        public List<Comment> GetCommentsForContract(int contractNr)
            => commentDAL.GetCommentsByContract(contractNr);

        public List<Comment> GetCommentsByBlock(int contractNr, int blockNr)
            => commentDAL.GetCommentsByBlock(contractNr, blockNr);

        public List<Comment> GetInternalComments(int contractNr)
            => commentDAL.GetInternalComments(contractNr);

        public List<Comment> GetExternalCommentsByUser(int contractNr, int extUserId)
            => commentDAL.GetExternalCommentsByUser(contractNr, extUserId);
    }

    // ==================== APPROVAL CONTROLLER ====================
    public class ApprovalController
    {
        private ContractStakeholderDAL stakeholderDAL = new ContractStakeholderDAL();
        private ContractDAL contractDAL = new ContractDAL();

        public bool ApproveContract(int contractNr, int userId)
        {
            List<ContractStakeholder> stakeholders = stakeholderDAL.GetStakeholdersByContract(contractNr);
            ContractStakeholder stakeholder = stakeholders.Find(s => s.Int_User_ID == userId);

            if (stakeholder == null || !stakeholder.Has_approval_rights)
                return false;

            // Mark stakeholder as approved
            stakeholder.Approved = true;
            stakeholder.Approved_date = DateTime.Now;
            stakeholderDAL.UpdateStakeholder(stakeholder);

            // Check if all approvals done
            if (stakeholderDAL.IsContractFullyApproved(contractNr))
            {
                Contract contract = contractDAL.GetContractById(contractNr);
                contract.Approved = true;
                return contractDAL.UpdateContract(contract);
            }

            return true;
        }

        public bool IsContractFullyApproved(int contractNr)
            => stakeholderDAL.IsContractFullyApproved(contractNr);

        public List<ContractStakeholder> GetStakeholders(int contractNr)
            => stakeholderDAL.GetStakeholdersByContract(contractNr);
    }
}

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

Program.cs

//////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using ContractManagement.Controller;
using ContractManagement.Model.Entities;

namespace ContractManagement.View
{
    // ==================== MAIN PROGRAM ====================
    class Program
    {
        static void Main(string[] args)
        {
            ConsoleUI ui = new ConsoleUI();
            ui.Start();
        }
    }

    //LISSIN TMN
    // ============= ABSTRACT USER SESSION ================
    public abstract class UserSession
    {
        protected string Username;
        protected int UserId;

        public UserSession(int userId, string username)
        {
            UserId = userId;
            Username = username;
        }

        public abstract void ShowMenu();

        protected void Pause()
        {
            Console.WriteLine("\nPress any key to continue...");
            Console.ReadKey();
        }

        protected int ReadInt(string prompt)
        {
            Console.Write(prompt);
            if (int.TryParse(Console.ReadLine(), out int result))
                return result;
            return -1;
        }
    }

    // ================== ADMIN SESSION ===================
    public class AdminSession : UserSession
    {
        private UserController _userController = new UserController();

        public AdminSession(int userId, string username) : base(userId, username) { }

        public override void ShowMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("===========================================");
                Console.WriteLine($"   ADMINISTRATOR MENU - {Username}");
                Console.WriteLine("===========================================");
                Console.WriteLine("1. Create Internal User");
                Console.WriteLine("2. Create External User");
                Console.WriteLine("3. View All Internal Users");
                Console.WriteLine("4. View All External Users");
                Console.WriteLine("5. Delete Internal User");
                Console.WriteLine("6. Delete External User");
                Console.WriteLine("0. Logout");
                Console.Write("\nSelect option: ");

                switch (Console.ReadLine())
                {
                    case "1": CreateInternalUser(); break;
                    case "2": CreateExternalUser(); break;
                    case "3": ViewAllInternalUsers(); break;
                    case "4": ViewAllExternalUsers(); break;
                    case "5": DeleteInternalUser(); break;
                    case "6": DeleteExternalUser(); break;
                    case "0": return;
                    default: Console.WriteLine("Invalid option."); Pause(); break;
                }
            }
        }

        private void CreateInternalUser()
        {
            Console.Clear();
            Console.WriteLine("=== CREATE INTERNAL USER ===\n");
            Console.Write("First Name: "); string firstName = Console.ReadLine();
            Console.Write("Last Name: "); string lastName = Console.ReadLine();
            Console.Write("Email: "); string email = Console.ReadLine();
            Console.Write("Username: "); string username = Console.ReadLine();
            Console.Write("Password: "); string password = Console.ReadLine();

            bool success = _userController.CreateInternalUser(firstName, lastName, email, username, password);
            Console.WriteLine(success ? "\n Internal user created successfully!" : "\n Failed to create user.");
            Pause();
        }

        private void CreateExternalUser()
        {
            Console.Clear();
            Console.WriteLine("=== CREATE EXTERNAL USER ===\n");
            Console.Write("First Name: "); string firstName = Console.ReadLine();
            Console.Write("Last Name: "); string lastName = Console.ReadLine();
            Console.Write("Company Name: "); string company = Console.ReadLine();
            Console.Write("Email: "); string email = Console.ReadLine();
            Console.Write("Username: "); string username = Console.ReadLine();
            Console.Write("Password: "); string password = Console.ReadLine();

            bool success = _userController.CreateExternalUser(firstName, lastName, company, email, username, password);
            Console.WriteLine(success ? "\n External user created successfully!" : "\n Failed to create user.");
            Pause();
        }

        private void ViewAllInternalUsers()
        {
            Console.Clear();
            Console.WriteLine("=== ALL INTERNAL USERS ===\n");
            var users = _userController.GetAllInternalUsers();
            if (users.Count == 0) Console.WriteLine("No internal users found.");
            else foreach (var u in users)
                    Console.WriteLine($"[{u.Int_User_ID}] {u.First_name} {u.Last_name} - {u.Username} ({u.Email})");
            Pause();
        }

        private void ViewAllExternalUsers()
        {
            Console.Clear();
            Console.WriteLine("=== ALL EXTERNAL USERS ===\n");
            var users = _userController.GetAllExternalUsers();
            if (users.Count == 0) Console.WriteLine("No external users found.");
            else foreach (var u in users)
                    Console.WriteLine($"[{u.Ext_User_ID}] {u.First_name} {u.Last_name} - {u.Company_name} ({u.Email})");
            Pause();
        }

        private void DeleteInternalUser()
        {
            ViewAllInternalUsers();
            Console.Write("\nEnter User ID to delete: ");
            if (int.TryParse(Console.ReadLine(), out int id))
            {
                bool success = _userController.DeleteInternalUser(id);
                Console.WriteLine(success ? "\n User deleted successfully!" : "\n Failed to delete user.");
            }
            else Console.WriteLine("Invalid ID.");
            Pause();
        }

        private void DeleteExternalUser()
        {
            ViewAllExternalUsers();
            Console.Write("\nEnter User ID to delete: ");
            if (int.TryParse(Console.ReadLine(), out int id))
            {
                bool success = _userController.DeleteExternalUser(id);
                Console.WriteLine(success ? "\n User deleted successfully!" : "\n Failed to delete user.");
            }
            else Console.WriteLine("Invalid ID.");
            Pause();
        }
    }

    // ================ INTERNAL USER SESSION =================
    public class InternalUserSession : UserSession
    {
        private BlockController _blockController = new BlockController();
        private ContractController _contractController = new ContractController();
        private CommentController _commentController = new CommentController();
        private ApprovalController _approvalController = new ApprovalController();

        public InternalUserSession(int userId, string username) : base(userId, username) { }

        public override void ShowMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("===========================================");
                Console.WriteLine($"   INTERNAL USER MENU - {Username}");
                Console.WriteLine("===========================================");
                Console.WriteLine("1. Block & Category Management");
                Console.WriteLine("2. Contract Management");
                Console.WriteLine("3. My Contracts (as Reviewer)");
                Console.WriteLine("4. View Contract Details");
                Console.WriteLine("5. Comment on Contract");
                Console.WriteLine("6. Approve Contract");
                Console.WriteLine("0. Logout");
                Console.Write("\nSelect option: ");

                switch (Console.ReadLine())
                {
                    case "1": BlockManagementMenu(); break;
                    case "2": ContractManagementMenu(); break;
                    case "3": ViewMyContractsAsReviewer(); break;
                    case "4": ViewContractDetails(); break;
                    case "5": AddCommentToContract(); break;
                    case "6": ApproveContractMenu(); break;
                    case "0": return;
                    default: Console.WriteLine("Invalid option."); Pause(); break;
                }
            }
        }

        // ======= BLOCK MANAGEMENT ========
        private void BlockManagementMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("=== BLOCK & CATEGORY MANAGEMENT ===");
                Console.WriteLine("1. Create Category");
                Console.WriteLine("2. View All Categories");
                Console.WriteLine("3. Create Original Block");
                Console.WriteLine("4. View All Original Blocks");
                Console.WriteLine("5. View Blocks by Category");
                Console.WriteLine("6. Copy Block");
                Console.WriteLine("0. Back");
                Console.Write("\nSelect option: ");

                switch (Console.ReadLine())
                {
                    case "1": CreateCategory(); break;
                    case "2": ViewAllCategories(); break;
                    case "3": CreateOriginalBlock(); break;
                    case "4": ViewAllOriginalBlocks(); break;
                    case "5": ViewBlocksByCategory(); break;
                    case "6": CopyBlock(); break;
                    case "0": return;
                    default: Console.WriteLine("Invalid option."); Pause(); break;
                }
            }
        }

        private void CreateCategory()
        {
            Console.Clear();
            Console.WriteLine("=== CREATE CATEGORY ===\n");
            Console.Write("Category Name: "); string name = Console.ReadLine();
            Console.Write("Description: "); string description = Console.ReadLine();
            bool success = _blockController.CreateCategory(name, description);
            Console.WriteLine(success ? "\n Category created successfully!" : "\n Failed to create category.");
            Pause();
        }

        private void ViewAllCategories()
        {
            Console.Clear();
            Console.WriteLine("=== ALL CATEGORIES ===\n");
            var categories = _blockController.GetAllCategories();
            if (categories.Count == 0) Console.WriteLine("No categories found.");
            else foreach (var c in categories)
                    Console.WriteLine($"[{c.Category_name}] - {c.Description}");
            Pause();
        }

        private void CreateOriginalBlock()
        {
            ViewAllCategories();
            Console.Write("\nCategory Name: "); string category = Console.ReadLine();
            Console.Write("Block Text: "); string text = Console.ReadLine();
            bool success = _blockController.CreateOriginalBlock(category, text, UserId);
            Console.WriteLine(success ? "\n Block created successfully!" : "\n Failed to create block.");
            Pause();
        }

        private void ViewAllOriginalBlocks()
        {
            Console.Clear();
            Console.WriteLine("=== ALL ORIGINAL BLOCKS ===\n");
            var blocks = _blockController.GetAllOriginalBlocks();
            if (blocks.Count == 0) Console.WriteLine("No blocks found.");
            else foreach (var b in blocks)
                    Console.WriteLine($"\n[{b.Org_Cont_ID}] Category: {b.Category_name}\nText: {b.Contract_text}\nCreated: {b.Created_date:yyyy-MM-dd}");
            Pause();
        }

        private void ViewBlocksByCategory()
        {
            ViewAllCategories();
            Console.Write("\nEnter Category Name: "); string category = Console.ReadLine();
            var blocks = _blockController.GetOriginalBlocksByCategory(category);
            if (blocks.Count == 0) Console.WriteLine("\nNo blocks found in this category.");
            else foreach (var b in blocks) Console.WriteLine($"\n[{b.Org_Cont_ID}] {b.Contract_text}");
            Pause();
        }

        private void CopyBlock()
        {
            ViewAllOriginalBlocks();
            Console.Write("\nEnter Original Block ID to copy: ");
            if (int.TryParse(Console.ReadLine(), out int id))
            {
                bool success = _blockController.CopyOriginalBlock(id, UserId);
                Console.WriteLine(success ? "\n Block copied successfully!" : "\n Failed to copy block.");
            }
            else Console.WriteLine("Invalid ID.");
            Pause();
        }

        // ========== CONTRACT MANAGEMENT ==========
        private void ContractManagementMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("=== CONTRACT MANAGEMENT ===");
                Console.WriteLine("1. Create New Contract");
                Console.WriteLine("2. View My Contracts");
                Console.WriteLine("3. Add Block to Contract");
                Console.WriteLine("4. Remove Block from Contract");
                Console.WriteLine("5. Edit Block in Contract");
                Console.WriteLine("6. Invite Internal Reviewers");
                Console.WriteLine("7. Invite External Users");
                Console.WriteLine("0. Back");
                Console.Write("\nSelect option: ");

                switch (Console.ReadLine())
                {
                    case "1": CreateContract(); break;
                    case "2": ViewMyContracts(); break;
                    case "3": AddBlockToContract(); break;
                    case "4": RemoveBlockFromContract(); break;
                    case "5": EditBlockInContract(); break;
                    case "6": InviteInternalReviewers(); break;
                    case "7": InviteExternalUsers(); break;
                    case "0": return;
                    default: Console.WriteLine("Invalid option."); Pause(); break;
                }
            }
        }

        // ============ CONTRACT METHODS ====================
        private void CreateContract()
        {
            Console.Clear();
            Console.WriteLine("=== CREATE NEW CONTRACT ===");
            Console.Write("Contract Name: "); string name = Console.ReadLine();

            int contractId = _contractController.CreateContract(name, UserId);

            bool success = contractId > 0;
            Console.WriteLine(success ? "\n Contract created successfully!" : "\n Failed to create contract.");
            Pause();
        }

        private void ViewMyContracts()
        {
            Console.Clear();
            Console.WriteLine("=== MY CONTRACTS ===");
            var contracts = _contractController.GetContractsByInternalUser(UserId);
            if (contracts.Count == 0) Console.WriteLine("No contracts found.");
            else foreach (var c in contracts)
                    Console.WriteLine($"[{c.Contract_NR}] {c.Company_name} (Created: {c.Created_date:yyyy-MM-dd})");
            Pause();
        }

        private void AddBlockToContract()
        {
            ViewMyContracts();
            int contractId = ReadInt("\nEnter Contract ID: ");
            ViewAllOriginalBlocks();
            int blockId = ReadInt("\nEnter Block ID to add: ");
            bool success = _contractController.AddBlockToContract(contractId, blockId);
            Console.WriteLine(success ? "\n Block added to contract!" : "\n Failed to add block.");
            Pause();
        }

        private void RemoveBlockFromContract()
        {
            ViewMyContracts();
            int contractId = ReadInt("\nEnter Contract ID: ");
            var blocks = _contractController.GetBlocksByContract(contractId);
            if (blocks.Count == 0) { Console.WriteLine("No blocks in this contract."); Pause(); return; }
            foreach (var b in blocks) Console.WriteLine($"[{b.Org_Cont_ID}] {b.Contract_text}");
            int blockId = ReadInt("\nEnter Block ID to remove: ");
            bool success = _contractController.RemoveBlockFromContract(contractId, blockId);
            Console.WriteLine(success ? "\n Block removed!" : "\n Failed to remove block.");
            Pause();
        }

        private void EditBlockInContract()
        {
            ViewMyContracts();
            int contractId = ReadInt("\nEnter Contract ID: ");
            var blocks = _contractController.GetBlocksByContract(contractId);
            if (blocks.Count == 0) { Console.WriteLine("No blocks in this contract."); Pause(); return; }
            foreach (var b in blocks) Console.WriteLine($"[{b.Org_Cont_ID}] {b.Contract_text}");
            int blockId = ReadInt("\nEnter Block ID to edit: ");
            Console.Write("New Block Text: "); string newText = Console.ReadLine();
            bool success = _contractController.EditBlockInContract(contractId, blockId, newText);
            Console.WriteLine(success ? "\n Block edited!" : "\n Failed to edit block.");
            Pause();
        }

        private void InviteInternalReviewers()
        {
            ViewMyContracts();
            int contractId = ReadInt("\nEnter Contract ID: ");
            var reviewers = new UserController().GetAllInternalUsers();
            foreach (var r in reviewers) Console.WriteLine($"[{r.Int_User_ID}] {r.First_name} {r.Last_name}");
            int reviewerId = ReadInt("\nEnter Reviewer ID to invite: ");
            bool success = _contractController.InviteInternalReviewer(contractId, reviewerId, false);
            Console.WriteLine(success ? "\n Reviewer invited!" : "\n Failed to invite reviewer.");
            Pause();
        }

        private void InviteExternalUsers()
        {
            ViewMyContracts();
            int contractId = ReadInt("\nEnter Contract ID: ");
            var externalUsers = new UserController().GetAllExternalUsers();
            foreach (var u in externalUsers) Console.WriteLine($"[{u.Ext_User_ID}] {u.First_name} {u.Last_name}");
            int userId = ReadInt("\nEnter External User ID to invite: ");
            bool success = _contractController.InviteExternalUser(contractId, userId);
            Console.WriteLine(success ? "\n External user invited!" : "\n Failed to invite.");
            Pause();
        }

        private void ViewMyContractsAsReviewer()
        {
            Console.Clear();
            Console.WriteLine("=== CONTRACTS TO REVIEW ===");
            var contracts = _contractController.GetContractsToReviewByInternalUser(UserId);
            if (contracts.Count == 0) Console.WriteLine("No contracts assigned for review.");
            else foreach (var c in contracts)
                    Console.WriteLine($"[{c.Contract_NR}] {c.Company_name}");
            Pause();
        }

        private void ViewContractDetails()
        {
            int contractId = ReadInt("\nEnter Contract ID to view details: ");
            var contract = _contractController.GetContractById(contractId);
            if (contract == null) { Console.WriteLine("Contract not found."); Pause(); return; }
            Console.WriteLine($"\nContract: {contract.Company_name}\nCreated: {contract.Created_date:yyyy-MM-dd}");
            var blocks = _contractController.GetBlocksByContract(contractId);
            foreach (var b in blocks) Console.WriteLine($"[{b.Org_Cont_ID}] {b.Contract_text}");
            Pause();
        }

        private void AddCommentToContract()
        {
            int contractId = ReadInt("\nEnter Contract ID to comment: ");
            Console.Write("Comment Text: "); string text = Console.ReadLine();
            bool success = _commentController.AddComment(contractId, null, UserId, text, "Internal");
            Console.WriteLine(success ? "\n Comment added!" : "\n Failed to add comment.");
            Pause();
        }

        private void ApproveContractMenu()
        {
            int contractId = ReadInt("\nEnter Contract ID to approve: ");
            bool success = _approvalController.ApproveContract(contractId, UserId);
            Console.WriteLine(success ? "\n Contract approved!" : "\n Failed to approve contract.");
            Pause();
        }

    }

    // ============= EXTERNAL USER SESSION ===================
    public class ExternalUserSession : UserSession
    {
        private ContractController _contractController = new ContractController();
        private CommentController _commentController = new CommentController();

        public ExternalUserSession(int userId, string username) : base(userId, username) { }

        public override void ShowMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("===========================================");
                Console.WriteLine($"   EXTERNAL USER MENU - {Username}");
                Console.WriteLine("===========================================");
                Console.WriteLine("1. View My Contracts");
                Console.WriteLine("2. View Contract Details");
                Console.WriteLine("3. Comment on Contract");
                Console.WriteLine("0. Logout");
                Console.Write("\nSelect option: ");

                switch (Console.ReadLine())
                {
                    case "1": ViewMyContracts(); break;
                    case "2": ViewContractDetails(); break;
                    case "3": AddCommentToContract(); break;
                    case "0": return;
                    default: Console.WriteLine("Invalid option."); Pause(); break;
                }
            }
        }

        private void ViewMyContracts()
        {
            Console.Clear();
            Console.WriteLine("=== MY CONTRACTS ===");
            var contracts = _contractController.GetContractsByExternalUser(UserId);
            if (contracts.Count == 0) Console.WriteLine("No contracts found.");
            else foreach (var c in contracts)
                    Console.WriteLine($"[{c.Contract_NR}] {c.Company_name} (Created: {c.Created_date:yyyy-MM-dd})");
            Pause();
        }

        private void ViewContractDetails()
        {
            int contractId = ReadInt("\nEnter Contract ID to view details: ");
            var contract = _contractController.GetContractById(contractId);
            if (contract == null) { Console.WriteLine("Contract not found."); Pause(); return; }
            Console.WriteLine($"\nContract: {contract.Company_name}\nCreated: {contract.Created_date:yyyy-MM-dd}");
            var blocks = _contractController.GetBlocksByContract(contractId);
            foreach (var b in blocks) Console.WriteLine($"[{b.Org_Cont_ID}] {b.Contract_text}");
            Pause();
        }

        private void AddCommentToContract()
        {
            int contractId = ReadInt("\nEnter Contract ID to comment: ");
            Console.Write("Comment Text: "); string text = Console.ReadLine();
            bool success = _commentController.AddComment(contractId, null, UserId, text, "External");
            Console.WriteLine(success ? "\n Comment added!" : "\n Failed to add comment.");
            Pause();
        }
    }

    // ==================== CONSOLE UI ====================
    public class ConsoleUI
    {
        private UserController _userController = new UserController();

        public void Start()
        {
            Console.WriteLine("===========================================");
            Console.WriteLine("   CONTRACT MANAGEMENT SYSTEM");
            Console.WriteLine("===========================================\n");

            while (true)
            {
                UserSession session = Login();
                if (session != null) session.ShowMenu();
            }
        }

        private UserSession Login()
        {
            Console.WriteLine("LOGIN");
            Console.WriteLine("1. Administrator Login");
            Console.WriteLine("2. Internal User Login");
            Console.WriteLine("3. External User Login");
            Console.WriteLine("0. Exit");
            Console.Write("\nSelect login type: ");

            string choice = Console.ReadLine();

            if (choice == "0")
            {
                Console.WriteLine("\nExiting application...");
                Environment.Exit(0);
            }

            Console.Write("Username: "); string username = Console.ReadLine();
            Console.Write("Password: "); string password = Console.ReadLine();

            switch (choice)
            {
                case "1":
                    var admin = _userController.LoginAdministrator(username, password);
                    if (admin != null)
                    {
                        Console.WriteLine($"\nWelcome, Administrator {admin.First_name} {admin.Last_name}!");
                        Pause();
                        return new AdminSession(admin.Administrator_ID, admin.Username);
                    }
                    break;
                case "2":
                    var intUser = _userController.LoginInternalUser(username, password);
                    if (intUser != null)
                    {
                        Console.WriteLine($"\nWelcome, {intUser.First_name} {intUser.Last_name}!");
                        Pause();
                        return new InternalUserSession(intUser.Int_User_ID, intUser.Username);
                    }
                    break;
                case "3":
                    var extUser = _userController.LoginExternalUser(username, password);
                    if (extUser != null)
                    {
                        Console.WriteLine($"\nWelcome, {extUser.First_name} {extUser.Last_name} from {extUser.Company_name}!");
                        Pause();
                        return new ExternalUserSession(extUser.Ext_User_ID, extUser.Username);
                    }
                    break;
            }
            Console.WriteLine("\nInvalid username or password.");
            Pause();
            return null;
        }

        private void Pause()
        {
            Console.WriteLine("\nPress any key to continue...");
            Console.ReadKey();
        }
    }
}